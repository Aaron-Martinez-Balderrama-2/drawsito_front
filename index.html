<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Drawsito UML</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="estilos.css"/>
  <style>
    /* Mini modal auth */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
    .modal .box{background:#fff;border:1px solid #d9dde5;border-radius:.8rem;padding:1rem;min-width:300px;max-width:360px}
    .modal .box h3{margin-bottom:.5rem}
    .modal .box label{display:block;font-size:12px;color:#334155;margin:.35rem 0 .2rem}
    .modal .box input{width:100%;padding:.4rem .5rem;border:1px solid #d9dde5;border-radius:.45rem}
    .modal .box .fila{display:flex;gap:.5rem;margin-top:.6rem}
    .modal .box button{flex:1 1 auto;border:1px solid #d9dde5;background:#fbfdff;padding:.45rem .6rem;border-radius:.5rem;cursor:pointer}
    .pill{font-size:12px;color:#475569;margin-left:.35rem}

    /* === Overlays (editor inline + editor de aristas) === */
    #editor_inline{
      display:none; position:fixed; z-index:1000;
      box-shadow:0 6px 18px rgba(0,0,0,.1);
      border:1px solid #cbd5e1; border-radius:8px;
      padding:6px 8px; font:13px system-ui; background:#fff;
      min-width:120px;
    }
    #editor_arista{
      display:none; position:fixed; z-index:1001;
      background:#fff; border:1px solid #e5e7eb; border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.12);
      padding:12px; min-width:340px; max-width:520px;
    }
    #editor_arista label{display:block;font:600 12px system-ui;color:#0f172a;margin:6px 0 4px}
    #editor_arista input[type="text"],
    #editor_arista input[type="number"],
    #editor_arista select{
      width:100%; box-sizing:border-box; padding:6px 8px;
      border:1px solid #cbd5e1; border-radius:8px; font:13px system-ui;
    }
    #editor_arista .ea-grid{display:grid;grid-template-columns:1.2fr 1fr 1fr;gap:10px}
    #editor_arista .ea-col{display:flex;flex-direction:column}
    #editor_arista .ea-subtitle{font:700 12px system-ui;color:#0b1324;margin:4px 0}
    #editor_arista .ea-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    #editor_arista .ea-ok{background:#0ea5e9;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    #editor_arista .ea-cancel{background:#f1f5f9;color:#0f172a;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}

    /* Bot√≥n de eliminar (overlay posicionado por JS) */
    #btn_borrar_sel{
      position:fixed; display:none; z-index:1002;
      background:#ef4444; color:#fff; border:0;
      padding:6px 10px; border-radius:8px; cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.18);
    }
  </style>
</head>
<body>
<header class="barra">
  <strong>Drawsito</strong>

  <button id="btn_guardar">Guardar</button>
  <button id="btn_cargar">Cargar</button>
  <input id="inp_id" placeholder="id a cargar / sala (p.ej. dibujo-20251021-210000)" size="34"/>
  <button id="btn_colaborar" title="Unirse a la sala con este ID">Colaborar</button>
  <span id="lbl_colab" class="pill">‚Äî offline</span>

  <span class="sep"></span>
  <label class="zoomlbl">Zoom
    <select id="sel_zoom">
      <option>50%</option><option>75%</option><option selected>100%</option>
      <option>125%</option><option>150%</option><option>200%</option>
    </select>
  </label>

  <span class="sep"></span>
  <button id="btn_generar" title="Genera ZIP (Spring Boot + Flutter + SQL)">Generar proyecto</button>

  <span class="sep"></span>
  <span id="auth_area" class="pill">No has iniciado sesi√≥n
    <button id="btn_login">Entrar</button>
    <button id="btn_reg">Registrarse</button>
  </span>
  <span id="auth_logueado" class="pill" style="display:none">
    Hola, <b id="auth_alias">‚Äî</b>
    <button id="btn_logout">Salir</button>
  </span>
</header>

<main class="principal">
  <aside class="paleta">
    <h4>Paleta</h4>
    <div class="pieza" draggable="true" data-tipo="clase">üß± Clase UML</div>
    <div class="pieza" draggable="true" data-tipo="texto">üîñ Texto</div>
    <p class="nota">Arrastra una pieza al lienzo. Doble clic para editar. Enter agrega filas. Arrastra desde los c√≠rculos azules para conectar.</p>
  </aside>

  <section class="zona" id="zona_canvas">
    <canvas id="lienzo"></canvas>

    <!-- Editor inline (nodos / filas) -->
    <input id="editor_inline" type="text"/>

    <!-- Editor de arista: Asociaci√≥n (Multiplicidad, Navegabilidad, Rol, Calificador + Tipo UML) -->
    <form id="editor_arista" class="editor-arista">
      <div class="ea-grid">
        <div class="ea-col">
          <label for="ea_lbl">Etiqueta (nombre de la asociaci√≥n)</label>
          <input id="ea_lbl" type="text" placeholder="p.ej. realiza / pertenece a">

          <label for="ea_nav">Navegabilidad</label>
          <select id="ea_nav">
            <option value="o2d">Origen ‚Üí Destino</option>
            <option value="d2o">Destino ‚Üí Origen</option>
            <option value="both">Ambos extremos</option>
            <option value="none">Sin flechas</option>
          </select>

          <!-- Tipo UML (presets 2‚Äì6) -->
          <label for="ea_preset">Tipo UML</label>
          <select id="ea_preset" name="ea_preset">
            <option value="assoc">Asociaci√≥n (por defecto)</option>
            <option value="agg">Agregaci√≥n (‚óá hueco)</option>
            <option value="comp">Composici√≥n (‚óÜ lleno)</option>
            <option value="gen">Generalizaci√≥n (‚ñ≥ hueco)</option>
            <option value="real">Realizaci√≥n (‚ñ≥ hueco + discontinua)</option>
            <option value="dep">Dependencia (V abierta + discontinua)</option>
          </select>

          <label for="ea_sz">Tama√±o de texto (10‚Äì24)</label>
          <input id="ea_sz" type="number" min="10" max="24" step="1" value="12">
        </div>

        <div class="ea-col">
          <div class="ea-subtitle">Extremo Origen</div>
          <label for="ea_o">Multiplicidad (Origen)</label>
          <input id="ea_o" type="text" placeholder="1, 0..1, 0.., 1.., *">

          <label for="ea_role_o">Rol (Origen)</label>
          <input id="ea_role_o" type="text" placeholder="p.ej. cliente, padre, due√±o">

          <label for="ea_qual_o">Calificador (Origen)</label>
          <input id="ea_qual_o" type="text" placeholder="p.ej. [n√∫mero], [c√≥digo]">
        </div>

        <div class="ea-col">
          <div class="ea-subtitle">Extremo Destino</div>
          <label for="ea_d">Multiplicidad (Destino)</label>
          <input id="ea_d" type="text" placeholder="1, 0..1, 0.., 1.., *">

          <label for="ea_role_d">Rol (Destino)</label>
          <input id="ea_role_d" type="text" placeholder="p.ej. pedido, hijo, mascota">

          <label for="ea_qual_d">Calificador (Destino)</label>
          <input id="ea_qual_d" type="text" placeholder="p.ej. [fecha], [tipo]">
        </div>
      </div>

      <div class="ea-actions">
        <button type="submit" class="ea-ok">Aplicar</button>
        <button type="button" id="ea_cancel" class="ea-cancel">Cancelar</button>
      </div>
    </form>

    <button id="btn_borrar_sel">üóë Eliminar</button>
  </section>

  <aside class="panel">
    <h4>Opciones</h4>
    <div class="grupo">
      <label><input type="checkbox" id="opt_ver_grid" checked> Cuadr√≠cula</label><br/>
      <label><input type="checkbox" id="opt_ver_pag" checked> Vista de la p√°gina</label><br/>
      <label><input type="checkbox" id="opt_conectores" checked> Puntos de conexi√≥n</label>
    </div>
    <div class="grupo">
      <div class="etq">Tama√±o del papel</div>
      <select id="sel_papel">
        <option value="A4" selected>A4 (210 √ó 297 mm)</option>
        <option value="Letter">Carta (216 √ó 279 mm)</option>
      </select>
      <div class="fila">
        <label><input type="radio" name="ori" value="v" checked> Vertical</label>
        <label><input type="radio" name="ori" value="h"> Horizontal</label>
      </div>
      <small class="nota">La hoja se expande/contrae por bloques seg√∫n el contenido.</small>
    </div>
    <hr/>
    <div id="panel_clase" class="grupo" style="display:none">
      <h5>Clase UML</h5>
      <label class="etq">Nombre</label>
      <input type="text" id="clase_titulo" placeholder="Nombre de la clase"/>
      <div class="fila"><button id="btn_add_atr">+ Atributo</button><button id="btn_add_met">+ M√©todo</button></div>
      <small class="nota">Consejo: doble clic para editar. Vac√≠o + Enter elimina fila.</small>
    </div>
  </aside>
</main>

<div class="ayuda">Ctrl + rueda = Zoom ‚Ä¢ Backspace/Del elimina ‚Ä¢ Doble clic en l√≠nea = editar etiqueta/cardinalidades</div>

<!-- Modales Auth -->
<div id="modal_login" class="modal">
  <div class="box">
    <h3>Iniciar sesi√≥n</h3>
    <label>Email</label><input type="email" id="lg_email">
    <label>Contrase√±a</label><input type="password" id="lg_pass">
    <div class="fila">
      <button id="btn_login_ok">Entrar</button>
      <button onclick="document.getElementById('modal_login').style.display='none'">Cancelar</button>
    </div>
  </div>
</div>

<div id="modal_reg" class="modal">
  <div class="box">
    <h3>Crear cuenta</h3>
    <label>Alias</label><input type="text" id="rg_alias">
    <label>Email</label><input type="email" id="rg_email">
    <label>Contrase√±a</label><input type="password" id="rg_p1">
    <label>Repite contrase√±a</label><input type="password" id="rg_p2">
    <div class="fila">
      <button id="btn_reg_ok">Registrar</button>
      <button onclick="document.getElementById('modal_reg').style.display='none'">Cancelar</button>
    </div>
  </div>
</div>

<script>
  window.DRAWSITO_CONFIG = {
    api:  "/proyecto/drawsito_back/api.php",
    rt:   "/proyecto/drawsito_back/tiempo_real.php",
    ws:   "ws://localhost:8088",  // WebSocket relay (instant√°neo)
    auth: "/proyecto/drawsito_back/auth.php"
  };
  window.DRAWSITO_SESSION = { token:'', user:null };
</script>

<script src="core/estado.js"></script>
<script src="core/pagina.js"></script>
<script src="core/render.js"></script>
<script src="core/colaboracion.js"></script>
<script src="core/interaccion.js"></script>
<script src="app.js"></script>

<script>
/* ======== Auth UI (simple) =============================================== */
(async function authInit(){
  try{
    const r = await fetch(DRAWSITO_CONFIG.auth+'?accion=whoami');
    const d = await r.json();
    if (d.ok){ DRAWSITO_SESSION.token=d.token; DRAWSITO_SESSION.user=d.user||null; }
  }catch(_){}
  pintarAuth();
})();

function pintarAuth(){
  const u = DRAWSITO_SESSION.user;
  document.getElementById('auth_area').style.display = u? 'none':'inline';
  document.getElementById('auth_logueado').style.display = u? 'inline':'none';
  if (u){ document.getElementById('auth_alias').textContent = u.alias || ('u#'+u.id); }
}

document.getElementById('btn_login').onclick = ()=> (document.getElementById('modal_login').style.display='flex');
document.getElementById('btn_reg').onclick   = ()=> (document.getElementById('modal_reg').style.display='flex');

document.getElementById('btn_login_ok').onclick = async ()=>{
  const email = document.getElementById('lg_email').value.trim();
  const pass  = document.getElementById('lg_pass').value;
  const fd = new FormData(); fd.append('accion','login'); fd.append('email',email); fd.append('pass',pass); fd.append('token', DRAWSITO_SESSION.token);
  const r = await fetch(DRAWSITO_CONFIG.auth, {method:'POST', body:fd});
  const d = await r.json();
  if(!d.ok) return alert(d.msg||'Error');
  DRAWSITO_SESSION.user=d.user; document.getElementById('modal_login').style.display='none'; pintarAuth();
};

document.getElementById('btn_reg_ok').onclick = async ()=>{
  const alias = document.getElementById('rg_alias').value.trim();
  const email = document.getElementById('rg_email').value.trim();
  const p1    = document.getElementById('rg_p1').value;
  const p2    = document.getElementById('rg_p2').value;
  const fd = new FormData();
  fd.append('accion','registrar'); fd.append('alias',alias); fd.append('email',email);
  fd.append('pass1',p1); fd.append('pass2',p2); fd.append('token', DRAWSITO_SESSION.token);
  const r = await fetch(DRAWSITO_CONFIG.auth, {method:'POST', body:fd});
  const d = await r.json();
  if(!d.ok) return alert(d.msg||'Error');
  DRAWSITO_SESSION.user=d.user; document.getElementById('modal_reg').style.display='none'; pintarAuth();
};

document.getElementById('btn_logout').onclick = async ()=>{
  const fd = new FormData(); fd.append('accion','logout'); fd.append('token', DRAWSITO_SESSION.token);
  const r = await fetch(DRAWSITO_CONFIG.auth, {method:'POST', body:fd});
  const d = await r.json();
  if(d.ok){ DRAWSITO_SESSION.user=null; pintarAuth(); }
};

/* Colaboraci√≥n: une a la sala usando el ID (igual que antes) */
document.getElementById('btn_colaborar').onclick = async ()=>{
  const id = (document.getElementById('inp_id').value||'').trim();
  if (!id) return alert('Escribe un ID de sala (usa el mismo que el de guardado)');
  try{
    await DS.collab.unirse(id);
    document.getElementById('lbl_colab').textContent = 'Sala: '+id+' (sincronizando)';
  }catch(e){ alert('No se pudo unir a la sala'); }
};
</script>

<!-- Generar proyecto (ZIP) -->
<script>
(function(){
  const btn = document.getElementById('btn_generar');
  btn.addEventListener('click', ()=>{
    const id = (document.getElementById('inp_id').value||'').trim();
    if (!id) { alert('Primero guarda el diagrama. Usa ese ID aqu√≠.'); return; }
    window.location.href = "/proyecto/drawsito_back/generar_proyecto.php?id="+encodeURIComponent(id);
  });
})();
</script>
</body>
</html>